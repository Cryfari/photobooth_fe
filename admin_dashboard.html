<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Photobooth</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #FFFFFF;
            --main-bg: #F7F8FC;
            --card-bg: #FFFFFF;
            --primary-orange: #F58D3D;
            --text-dark: #252733;
            --text-gray: #9FA2B4;
            --text-inactive: #4B5563;
            --border-color: #DFE0EB;
            --danger-color: #D73737;
            --font-family: 'Mulish', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: var(--font-family); background-color: var(--main-bg); color: var(--text-dark); font-size: 14px; }

        .admin-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 255px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 30px; overflow-x: hidden; }
        .sidebar-header { display: flex; align-items: center; gap: 16px; padding: 24px 30px; font-size: 1.2rem; font-weight: 700; letter-spacing: 0.3px; border-bottom: 1px solid var(--border-color); }
        .sidebar-nav { padding: 16px; }
        .sidebar-nav .nav-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-gray); font-weight: 700; padding: 8px 14px; margin-bottom: 8px; }
        .sidebar-nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav a { display: flex; align-items: center; gap: 16px; padding: 12px 14px; margin-bottom: 4px; border-radius: 8px; text-decoration: none; color: var(--text-inactive); font-weight: 600; transition: all 0.2s ease-in-out; }
        .sidebar-nav a:hover { background-color: #F3F4F6; }
        .sidebar-nav a.active { background-color: var(--primary-orange); color: white; }
        .sidebar-nav a.active:hover { background-color: #E8832E; }
        .sidebar-nav svg { width: 20px; height: 20px; }

        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .content-header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .add-new-button { background-color: var(--primary-orange); color: white; padding: 10px 24px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 700; cursor: pointer; text-decoration: none; }
        .metric-card { background-color: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); padding: 24px 30px; margin-bottom: 30px; }
        .metric-card h2 { margin: 0; font-size: 1.2rem; }
        .metric-card p { margin: 4px 0 0; font-size: 2rem; font-weight: bold; color: var(--primary-orange); }
        .content-card { background-color: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .card-toolbar { display: flex; justify-content: flex-end; align-items: center; padding: 20px 30px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 20px; }
        .search-wrapper { position: relative; width: 300px; }
        .search-wrapper svg { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-gray); }
        #searchInput { width: 100%; padding: 10px 15px 10px 40px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; font-size: 14px; }
        #bulkDeleteBtn { background: none; border: 1px solid var(--border-color); color: var(--text-gray); border-radius: 8px; padding: 8px; cursor: pointer; line-height: 0; transition: all 0.2s; }
        #bulkDeleteBtn:not(:disabled):hover { border-color: var(--danger-color); color: var(--danger-color); }
        #bulkDeleteBtn:disabled { opacity: 0.5; cursor: not-allowed; }
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 20px 30px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { color: var(--text-gray); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.2px; white-space: nowrap; }
        th.sortable { cursor: pointer; }
        th.sortable .sort-icons { display: inline-flex; flex-direction: column; margin-left: 8px; opacity: 0.5; }
        th.sortable.asc .sort-icons, th.sortable.desc .sort-icons { opacity: 1; }
        th.sortable .sort-icons svg { width: 8px; height: 8px; fill: var(--text-dark); }
        th.sortable.asc .icon-asc { color: var(--primary-orange); }
        th.sortable.desc .icon-desc { color: var(--primary-orange); }
        table tr:last-child td { border-bottom: none; }
        table tr:hover { background-color: var(--main-bg); }
        td .template-info { display: flex; align-items: center; gap: 24px; font-weight: 600; }
        td .template-info img { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; }
        .action-link { background: none; border: none; padding: 4px; font-family: inherit; font-size: 14px; color: var(--text-gray); cursor: pointer; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
        .action-link.edit { color: var(--primary-orange); margin-right: 16px; }
        .action-link.delete { color: var(--danger-color); }
        .loader { text-align: center; padding: 50px; }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 30px;
            color: var(--text-gray);
            flex-wrap: wrap;
            gap: 20px;
            visibility: hidden; 
        }
        .pagination-info {
            flex-shrink: 0;
            color: var(--text-dark);
            font-weight: 600;
        }
        .items-per-page-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto; 
        }
        #itemsPerPageSelect {
            font-family: inherit;
            font-weight: 600;
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 5px;
        }
        .pagination-nav {
            display: flex;
            align-items: center;
            gap: 4px; 
        }
        .pagination-nav button {
            background: none;
            border: 1px solid transparent;
            color: var(--text-gray);
            font-weight: 600;
            padding: 7px 12px;
            margin: 0;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            min-width: 36px;
            text-align: center;
        }
        .pagination-nav button:hover:not(.active) {
            border-color: var(--border-color);
            background-color: var(--main-bg);
        }
        .pagination-nav button.active {
            border: 2px solid var(--primary-orange);
            color: var(--primary-orange);
            font-weight: 700;
            padding: 6px 11px;
        }
        .pagination-nav button:first-child, .pagination-nav button:last-child {
            font-size: 1.2rem;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(37, 39, 51, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--card-bg); padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--text-dark); }
        .modal-content p { margin: 0 0 25px 0; color: var(--text-gray); line-height: 1.5; }
        .modal-content hr { border: none; border-top: 1px solid var(--border-color); margin: 0 -30px 25px -30px; }
        .modal-actions { display: flex; gap: 15px; }
        .modal-button { flex-grow: 1; padding: 10px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; }
        .modal-button.cancel { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-gray); }
        .modal-button.delete { background-color: var(--danger-color); border: 1px solid var(--danger-color); color: white; }
    </style>
</head>
<body>

    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.7071 1.29289C18.0976 1.68342 18.0976 2.31658 17.7071 2.70711L14.4142 6L17.7071 9.29289C18.0976 9.68342 18.0976 10.3166 17.7071 10.7071C17.3166 11.0976 16.6834 11.0976 16.2929 10.7071L12.2929 6.70711C11.9024 6.31658 11.9024 5.68342 12.2929 5.29289L16.2929 1.29289C16.6834 0.902369 17.3166 0.902369 17.7071 1.29289Z" fill="#F59E0B"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 1C4.82841e-08 0.447715 0.447715 -4.8282e-08 1 0L13 1.04907e-06C13.5523 1.09736e-06 14 0.447716 14 1C14 1.55229 13.5523 2 13 2L1 2C0.447715 2 -4.82804e-08 1.55228 0 1Z" fill="#F59E0B"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 11C4.82841e-08 10.4477 0.447715 10 1 10L13 10C13.5523 10 14 10.4477 14 11C14 11.5523 13.5523 12 13 12L1 12C0.447715 12 -4.82804e-08 11.5523 0 11Z" fill="#F59E0B"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 6C4.82841e-08 5.44772 0.447715 5 1 5L9 5C9.55229 5 10 5.44772 10 6C10 6.55229 9.55229 7 9 7L1 7C0.447715 7 -4.82804e-08 6.55228 0 6Z" fill="#F59E0B"/>
                    </svg>
                <span>AI Photobooth</span>
            </div>
            <nav class="sidebar-nav">
                <h4 class="nav-title">Settings</h4>
                <ul>
                    <li><a href="admin_dashboard.html" class="active">
                        <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M9.1135 0.715174C9.44522 0.833588 9.66668 1.14778 9.66668 1.5V6.5H14.6667C14.9887 6.5 15.2818 6.6855 15.4197 6.97648C15.5576 7.26745 15.5155 7.61183 15.3116 7.86104L7.81164 17.0277C7.5886 17.3003 7.21825 17.4032 6.88652 17.2848C6.55479 17.1664 6.33334 16.8522 6.33334 16.5V11.5H1.33334C1.01135 11.5 0.718171 11.3145 0.580284 11.0235C0.442398 10.7326 0.484481 10.3882 0.688378 10.139L8.18838 0.972306C8.41142 0.699697 8.78177 0.596761 9.1135 0.715174ZM3.09188 9.83334H7.16668C7.62691 9.83334 8.00001 10.2064 8.00001 10.6667V14.1655L12.9081 8.16667H8.83334C8.3731 8.16667 8.00001 7.79357 8.00001 7.33334V3.83451L3.09188 9.83334Z" fill="white"/>
                        </svg>
                        <span>Manage Template</span>
                    </a></li>
                    <li><a href="admin_change_password.html">
                        <svg width="20" height="16" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M10 2.16667C9.55801 2.16667 9.13409 2.34226 8.82153 2.65482C8.50897 2.96738 8.33337 3.39131 8.33337 3.83333C8.33337 4.27536 8.50897 4.69928 8.82153 5.01185C9.13409 5.32441 9.55801 5.5 10 5.5C10.4421 5.5 10.866 5.32441 11.1786 5.01185C11.4911 4.69928 11.6667 4.27536 11.6667 3.83333C11.6667 3.39131 11.4911 2.96738 11.1786 2.65482C10.866 2.34226 10.4421 2.16667 10 2.16667ZM7.64302 1.47631C8.26814 0.851189 9.11598 0.5 10 0.5C10.8841 0.5 11.7319 0.851189 12.3571 1.47631C12.9822 2.10143 13.3334 2.94928 13.3334 3.83333C13.3334 4.71739 12.9822 5.56523 12.3571 6.19036C11.7319 6.81548 10.8841 7.16667 10 7.16667C9.11599 7.16667 8.26814 6.81548 7.64302 6.19036C7.0179 5.56523 6.66671 4.71739 6.66671 3.83333C6.66671 2.94928 7.0179 2.10143 7.64302 1.47631ZM4.16671 5.5C3.94569 5.5 3.73373 5.5878 3.57745 5.74408C3.42117 5.90036 3.33337 6.11232 3.33337 6.33333C3.33337 6.55435 3.42117 6.76631 3.57745 6.92259C3.73373 7.07887 3.94569 7.16667 4.16671 7.16667C4.38772 7.16667 4.59968 7.07887 4.75596 6.92259C4.91224 6.76631 5.00004 6.55435 5.00004 6.33333C5.00004 6.11232 4.91224 5.90036 4.75596 5.74408C4.59968 5.5878 4.38772 5.5 4.16671 5.5ZM2.39894 4.56557C2.86778 4.09673 3.50367 3.83333 4.16671 3.83333C4.82975 3.83333 5.46563 4.09673 5.93447 4.56557C6.40331 5.03441 6.66671 5.67029 6.66671 6.33333C6.66671 6.99637 6.40331 7.63226 5.93447 8.1011C5.46563 8.56994 4.82975 8.83333 4.16671 8.83333C3.50367 8.83333 2.86778 8.56994 2.39894 8.1011C1.9301 7.63226 1.66671 6.99637 1.66671 6.33333C1.66671 5.67029 1.9301 5.03441 2.39894 4.56557ZM15.8334 5.5C15.6124 5.5 15.4004 5.5878 15.2441 5.74408C15.0878 5.90036 15 6.11232 15 6.33333C15 6.55435 15.0878 6.76631 15.2441 6.92259C15.4004 7.07887 15.6124 7.16667 15.8334 7.16667C16.0544 7.16667 16.2663 7.07887 16.4226 6.92259C16.5789 6.76631 16.6667 6.55435 16.6667 6.33333C16.6667 6.11232 16.5789 5.90036 16.4226 5.74408C16.2663 5.5878 16.0544 5.5 15.8334 5.5ZM14.0656 4.56557C14.5344 4.09673 15.1703 3.83333 15.8334 3.83333C16.4964 3.83333 17.1323 4.09673 17.6011 4.56557C18.07 5.03441 18.3334 5.67029 18.3334 6.33333C18.3334 6.99637 18.07 7.63226 17.6011 8.1011C17.1323 8.56994 16.4964 8.83333 15.8334 8.83333C15.1703 8.83333 14.5344 8.56994 14.0656 8.1011C13.5968 7.63226 13.3334 6.99637 13.3334 6.33333C13.3334 5.67029 13.5968 5.03441 14.0656 4.56557ZM10 9.66608C9.33359 9.66608 8.68242 9.86576 8.13052 10.2394C7.57863 10.613 7.15133 11.1433 6.90373 11.7621C6.75109 12.143 6.66671 12.5608 6.66671 13V13.8333H13.3334V13C13.3334 12.5608 13.2491 12.1434 13.0965 11.7625C12.8489 11.1437 12.4215 10.613 11.8696 10.2394C11.3177 9.86576 10.6665 9.66608 10 9.66608ZM15 13.8333H17.5V13.0001C17.5 13 17.5 13.0001 17.5 13.0001C17.5 12.6537 17.3921 12.3159 17.1912 12.0337C16.9904 11.7515 16.7066 11.5389 16.3793 11.4255C16.0521 11.312 15.6976 11.3033 15.3652 11.4006C15.1679 11.4584 14.9842 11.5518 14.8226 11.675C14.9385 12.0979 15 12.5425 15 13V13.8333ZM14.1082 10.148C13.7584 9.64433 13.317 9.20656 12.8038 8.85918C11.9761 8.29888 10.9996 7.99941 10 7.99941C9.00052 7.99941 8.02393 8.29888 7.19623 8.85918C6.68306 9.20656 6.24172 9.64433 5.89191 10.148C5.6465 9.99958 5.38156 9.88258 5.10308 9.80107C4.43824 9.60647 3.72928 9.62384 3.07476 9.85077C2.42025 10.0777 1.85269 10.5029 1.451 11.0673C1.0493 11.6317 0.833425 12.3072 0.833374 12.9999V14.6667C0.833374 15.1269 1.20647 15.5 1.66671 15.5H18.3334C18.7936 15.5 19.1667 15.1269 19.1667 14.6667V13C19.1667 12.3073 18.9508 11.6317 18.5491 11.0673C18.1474 10.5029 17.5798 10.0777 16.9253 9.85077C16.2708 9.62384 15.5618 9.60647 14.897 9.80107C14.6185 9.88258 14.3536 9.99958 14.1082 10.148ZM5.1775 11.675C5.01591 11.5518 4.8322 11.4584 4.6349 11.4006C4.30247 11.3033 3.94799 11.312 3.62074 11.4255C3.29348 11.5389 3.0097 11.7515 2.80885 12.0337C2.60802 12.3159 2.50008 12.6537 2.50004 13C2.50004 13 2.50004 13 2.50004 13V13.8333H5.00004V13C5.00004 12.5425 5.06157 12.0979 5.1775 11.675Z" fill="#111827"/>
                        </svg>
                        <span>Setting Password</span>
                    </a></li>
                    <li><a href="admin_setting_gdrive.html">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M1.23223 1.23223C1.70107 0.763392 2.33696 0.5 3 0.5H13C13.663 0.5 14.2989 0.763392 14.7678 1.23223C15.2366 1.70107 15.5 2.33696 15.5 3V13C15.5 13.663 15.2366 14.2989 14.7678 14.7678C14.2989 15.2366 13.663 15.5 13 15.5H3C2.33696 15.5 1.70107 15.2366 1.23223 14.7678C0.763392 14.2989 0.5 13.663 0.5 13V3C0.5 2.33696 0.763392 1.70107 1.23223 1.23223ZM10.5 2.16667H5.5V9.98497L7.62732 8.92131C7.86193 8.80401 8.13807 8.80401 8.37268 8.92131L10.5 9.98497V2.16667ZM3.83333 2.16667H3C2.77899 2.16667 2.56702 2.25446 2.41074 2.41074C2.25446 2.56702 2.16667 2.77899 2.16667 3V13C2.16667 13.221 2.25446 13.433 2.41074 13.5893C2.56702 13.7455 2.77899 13.8333 3 13.8333H13C13.221 13.8333 13.433 13.7455 13.5893 13.5893C13.7455 13.433 13.8333 13.221 13.8333 13V3C13.8333 2.77899 13.7455 2.56702 13.5893 2.41074C13.433 2.25446 13.221 2.16667 13 2.16667H12.1667V11.3333C12.1667 11.6221 12.0171 11.8904 11.7714 12.0422C11.5258 12.194 11.219 12.2079 10.9607 12.0787L8 10.5984L5.03934 12.0787C4.78102 12.2079 4.47424 12.194 4.22856 12.0422C3.98288 11.8904 3.83333 11.6221 3.83333 11.3333V2.16667Z" fill="#111827"/>
                        </svg>
                        <span>Setting Google Drive</span>
                    </a></li>
                    <li><a href="#" id="logoutButton">
                        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17 8l-1.41 1.41L17.17 11H9v2h8.17l-1.58 1.58L17 16l4-4L17 8z M5 5h7V3H5C3.9 3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h7v-2H5V5z"></path></svg>
                        <span>Logout Admin</span>
                    </a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="content-header">
                <h1>Template</h1>
                <a href="admin_add_template.html" class="add-new-button">Add New Template</a>
            </div>
            
            <div class="metric-card">
                <h2>Total Template</h2>
                <p id="totalTemplatesCount">0</p>
            </div>

            <div class="content-card">
                <div class="card-toolbar">
                    <button id="bulkDeleteBtn" disabled>
                         <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    </button>
                    <div class="search-wrapper">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="searchInput" placeholder="Search by name">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Image</th>
                                <th id="sortByName" class="sortable">
                                    <span>Name</span>
                                    <span class="sort-icons">
                                        <svg class="icon-asc" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14l5-5 5 5z"></path></svg>
                                        <svg class="icon-desc" viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"></path></svg>
                                    </span>
                                </th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="templatesTableBody">
                            <tr><td colspan="4" class="loader">Loading templates...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination-controls">
                    <div id="paginationInfo">Showing 0 to 0 of 0 results</div>
                    <div class="items-per-page-selector">
                        <select id="itemsPerPageSelect">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                        <span>per page</span>
                    </div>
                    <div id="paginationNav" class="pagination-nav"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="deleteConfirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="deleteModalTitle">Delete Template</h2>
            <p id="deleteModalText">Are you sure you want to delete this template?</p>
            <hr>
            <div class="modal-actions">
                <button id="cancelDeleteBtn" class="modal-button cancel">Cancel</button>
                <button id="confirmDeleteBtn" class="modal-button delete">Delete</button>
            </div>
        </div>
    </div>
    
    <script>
        
        let allTemplates = [];
        let searchTerm = '';
        let currentPage = 1;
        let itemsPerPage = 5;
        let sortState = { key: 'name', order: 'asc' };
        let selectedTemplates = new Set();
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const token = localStorage.getItem('adminToken');

        
        const tableBody = document.getElementById('templatesTableBody');
        const totalTemplatesCountEl = document.getElementById('totalTemplatesCount');
        const logoutButton = document.getElementById('logoutButton');
        const searchInput = document.getElementById('searchInput');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const sortByNameHeader = document.getElementById('sortByName');
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');

        function displayData() {
            const filtered = allTemplates.filter(template => template.name.toLowerCase().includes(searchTerm.toLowerCase()));
            filtered.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                if (nameA < nameB) return sortState.order === 'asc' ? -1 : 1;
                if (nameA > nameB) return sortState.order === 'asc' ? 1 : -1;
                return 0;
            });
            updateSortIndicator();
            const paginated = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            renderTable(paginated);
            renderPagination(filtered.length); 
            updateBulkDeleteButtonState();
        }

        function renderTable(templatesToRender) {
             tableBody.innerHTML = '';
            if (templatesToRender.length === 0) {
                const message = searchTerm ? 'No matching templates found.' : 'No templates have been added yet.';
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px;">${message}</td></tr>`;
                return;
            }

            templatesToRender.forEach(template => {
                const row = document.createElement('tr');
                const isSelected = selectedTemplates.has(template.name);
                const formattedName = template.name.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                row.innerHTML = `
                    <td><input type="checkbox" data-name="${template.name}" ${isSelected ? 'checked' : ''}></td>
                    <td><div class="template-info"><img src="${API_BASE_URL}/${template.url}" alt="${formattedName}"></div></td>
                    <td><div class="template-info">${formattedName}</div></td>
                    <td style="text-align: right;">
                        <a href="admin_edit_template.html?name=${template.name}" class="action-link edit"><svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg> Edit</a>
                        <button class="action-link delete"><svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg> Delete</button>
                    </td>
                `;
                row.querySelector('.delete').addEventListener('click', () => { handleSingleDelete(template.name, formattedName); });
                row.querySelector('input[type="checkbox"]').addEventListener('change', (e) => { handleCheckboxChange(e.target.dataset.name, e.target.checked); });
                tableBody.appendChild(row);
            });
            updateSelectAllCheckboxState();
        }

        
        function renderPagination(totalItems) {
            const paginationNav = document.getElementById('paginationNav');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationControls = document.querySelector('.pagination-controls');

            paginationNav.innerHTML = ''; 
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            
            const startItem = totalItems === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            paginationInfo.textContent = `Showing ${startItem} to ${endItem} of ${totalItems} results`;
            
            
            if (totalPages <= 1) {
                paginationControls.style.visibility = 'hidden';
                return;
            }
            paginationControls.style.visibility = 'visible';

            
            if (currentPage > 1) {
                const prevButton = document.createElement('button');
                prevButton.innerHTML = '&lsaquo;'; 
                prevButton.setAttribute('aria-label', 'Previous page');
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayData();
                    }
                });
                paginationNav.appendChild(prevButton);
            }
            
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    displayData();
                });
                paginationNav.appendChild(pageButton);
            }
            
           
            if (currentPage < totalPages) {
                const nextButton = document.createElement('button');
                nextButton.innerHTML = '&rsaquo;';
                nextButton.setAttribute('aria-label', 'Next page');
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayData();
                    }
                });
                paginationNav.appendChild(nextButton);
            }
        }

        async function fetchTemplates() {
            try {
                const response = await fetch(`${API_BASE_URL}/get-templates`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (response.status === 401) { handleUnauthorized(); return; }
                if (!response.ok) throw new Error('Failed to fetch templates.');
                allTemplates = await response.json();
                totalTemplatesCountEl.textContent = allTemplates.length;
                itemsPerPageSelect.value = itemsPerPage;
                displayData();
            } catch (error) {
                console.error("Error fetching templates:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="loader">Error loading data.</td></tr>`;
            }
        }

        function showConfirmationModal(names, formattedNames) {
            return new Promise((resolve) => {
                const isSingle = names.length === 1;
                const modal = document.getElementById('deleteConfirmationModal');
                const title = document.getElementById('deleteModalTitle');
                const text = document.getElementById('deleteModalText');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const cancelBtn = document.getElementById('cancelDeleteBtn');
                
                title.textContent = isSingle ? `Delete Template` : `Delete ${names.length} Templates`;
                text.textContent = isSingle 
                    ? `Are you sure you want to delete "${formattedNames[0]}"? This action cannot be undone.`
                    : `Are you sure you want to delete ${names.length} selected templates? This action cannot be undone.`;

                modal.classList.add('visible');
                
                const onConfirm = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                
                const cleanup = () => {
                    modal.classList.remove('visible');
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                };

                confirmBtn.addEventListener('click', onConfirm, { once: true });
                cancelBtn.addEventListener('click', onCancel, { once: true });
            });
        }

        async function handleSingleDelete(templateName, formattedName) {
            const confirmed = await showConfirmationModal([templateName], [formattedName]);
            if (!confirmed) return;
            await deleteTemplatesAPI([templateName]);
        }

        async function handleBulkDelete() {
            const namesToDelete = Array.from(selectedTemplates);
            if(namesToDelete.length === 0) return;
           
            const confirmed = await showConfirmationModal(namesToDelete, []);
            if(!confirmed) return;
            await deleteTemplatesAPI(namesToDelete);
        }

        async function deleteTemplatesAPI(names) {
            const deletePromises = names.map(name => fetch(`${API_BASE_URL}/delete-template/${name}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }}));
            try {
                const responses = await Promise.all(deletePromises);
                const failed = responses.find(res => !res.ok);
                if (failed) {
                    const errorData = await failed.json().catch(() => ({ detail: 'An unknown error occurred.'}));
                    throw new Error(errorData.detail || 'One or more templates failed to delete.');
                }
                alert(`${names.length} template(s) deleted successfully.`);
                selectedTemplates.clear();
                currentPage = 1;
                fetchTemplates();
            } catch (error) {
                console.error('Error deleting templates:', error);
                alert(`Error: ${error.message}`);
            }
        }

        function handleUnauthorized() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin_login.html';
        }

        function handleCheckboxChange(name, isChecked) {
            if(isChecked) { selectedTemplates.add(name); } 
            else { selectedTemplates.delete(name); }
            updateSelectAllCheckboxState();
            updateBulkDeleteButtonState();
        }

        function updateSelectAllCheckboxState() {
            const displayedCheckboxes = tableBody.querySelectorAll('input[type="checkbox"]');
            if (displayedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            const checkedCount = Array.from(displayedCheckboxes).filter(cb => cb.checked).length;
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === displayedCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function updateBulkDeleteButtonState() {
            bulkDeleteBtn.disabled = selectedTemplates.size === 0;
        }
        
        function updateSortIndicator() {
            sortByNameHeader.classList.remove('asc', 'desc');
            if(sortState.order === 'asc') sortByNameHeader.classList.add('asc');
            else if (sortState.order === 'desc') sortByNameHeader.classList.add('desc');
        }

        
        logoutButton.addEventListener('click', (e) => { e.preventDefault(); handleUnauthorized(); });
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = searchInput.value;
                currentPage = 1;
                displayData();
            }, 300);
        });
        itemsPerPageSelect.addEventListener('change', () => {
            itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
            currentPage = 1;
            displayData();
        });
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            tableBody.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
                handleCheckboxChange(checkbox.dataset.name, isChecked);
            });
        });
        sortByNameHeader.addEventListener('click', () => {
            sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
            displayData();
        });
        bulkDeleteBtn.addEventListener('click', handleBulkDelete);

        
        if (!token) {
            handleUnauthorized();
        } else {
            fetchTemplates();
        }
    </script>
</body>
</html>